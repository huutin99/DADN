<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
        </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous">
        </script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
    <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}">

    <title>Project</title>
</head>

<body>
    <div class="container">
        <!-- Content here -->
        <!-- As a heading -->
        <nav class="navbar navbar-light">
            <a class="navbar-brand d-flex" href="{{ url_for('login') }}">
                <img src="{{url_for('static', filename='./img/logo.jpg')}}" alt="logo" loading="lazy">
            </a>
            <div id="nav-name" class="d-flex">
                <i class="fa fa-user-circle-o"></i>
                <p id="user-name">{{username}}</p>
            </div>
            <div id="nav-logout" class="d-flex">
                <i class="fa fa-sign-out"></i>
                <a href="{{ url_for('logout') }}" class="text-dark">Log out</a>
            </div>
        </nav>
        <div class="row">
            <div class="col-3" id="title">
                <div class="list-group list-group-flush" id="list-tab" role="tablist">
                    <a class="list-group-item list-group-item-action active" id="overview-list" data-toggle="list"
                        href="#overview" role="tab" aria-controls="overview">Overview</a>
                    <a class="list-group-item list-group-item-action" id="controller-list" data-toggle="list"
                        href="#controller" role="tab" aria-controls="controller">Controller</a>
                    <a class="list-group-item list-group-item-action" id="report-list" data-toggle="list" href="#report"
                        role="tab" aria-controls="report">Report</a>
                    <a class="list-group-item list-group-item-action" id="status-list" data-toggle="list"
                        href="#list-settings" role="tab" aria-controls="status">Status</a>
                </div>
            </div>
            <div class="col-9" id="content">
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="overview" role="tabpanel"
                        aria-labelledby="overview-list">
                        <h1>Overview</h1>
                        <canvas id="myChart" width="400" height="200"></canvas>
                    </div>
                    <div class="tab-pane fade" id="controller" role="tabpanel" aria-labelledby="controller-list">
                        <h1>Controller</h1>
                        <div id="ctrl-tab">
                            <div id="ctrl-1">
                                <div id="ctrl-switch">
                                    <h2>Turn on/off</h2>
                                    <label class="switch">
                                        <input type="checkbox" id="switch-btn" checked onclick="check()">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div id="ctrl-adjust">
                                    <h2>Adjust intensity</h2>
                                    <div>
                                        <input type="range" min="0" max="255" step="1" value="" id="adjust-in"
                                            oninput="adjust(value)">
                                    </div>
                                    <output for="adjust" id="adjust-out"></output>
                                </div>
                            </div>
                            <div id="ctrl-2">
                                <img src="{{ url_for('static', filename='./img/bulb_normal.png') }}" alt="bulb"
                                    id="bulb_img">
                            </div>
                            <button onclick="send_adjust()">Apply</button>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="report" role="tabpanel" aria-labelledby="report-list">
                        <h1>Report</h1>
                        <div id="report-content">
                            <div id="device-list">
                                <div class="list-group" id="list-tab" role="tablist">
                                    <a class="list-group-item list-group-item-action active list-group-item-info"
                                        id="list-home-list" data-toggle="list" href="#report-sensor" role="tab"
                                        aria-controls="home">Sensor
                                        <span class="badge badge-primary badge-pill">14</span>
                                    </a>
                                    <a class="list-group-item list-group-item-action list-group-item-info"
                                        id="list-profile-list" data-toggle="list" href="#report-controller" role="tab"
                                        aria-controls="profile">Controller
                                        <span class="badge badge-primary badge-pill">14</span>
                                    </a>
                                </div>
                                <p>Choose date:</p>
                                <input type="date" id="report-date">
                            </div>
                            <div id="report-list">
                                <div class="tab-content" id="nav-tabContent">
                                    <div class="tab-pane fade show active" id="report-sensor" role="tabpanel"
                                        aria-labelledby="list-home-list">
                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
                                        tempor incididunt ut labore et dolore magna aliqua. In mollis nunc sed id
                                        semper risus in hendrerit. Imperdiet dui accumsan sit amet nulla facilisi
                                        morbi tempus. Volutpat blandit aliquam etiam erat velit scelerisque. Mi sit
                                        amet mauris commodo quis imperdiet massa. At consectetur lorem donec massa.
                                        Augue ut lectus arcu bibendum at varius vel pharetra vel. Leo urna molestie
                                        at elementum eu. Sed arcu non odio euismod lacinia at quis risus sed.
                                        Suspendisse potenti nullam ac tortor vitae purus faucibus ornare. Blandit
                                        massa enim nec dui nunc mattis enim ut tellus. Facilisi cras fermentum odio
                                        eu feugiat. Id neque aliquam vestibulum morbi blandit cursus risus at.
                                        Luctus accumsan tortor posuere ac ut consequat semper viverra. Commodo elit
                                        at imperdiet dui accumsan sit amet nulla facilisi.

                                        Id porta nibh venenatis cras sed felis. Quis viverra nibh cras pulvinar
                                        mattis. Felis eget nunc lobortis mattis aliquam. Commodo viverra maecenas
                                        accumsan lacus vel facilisis. Ac tincidunt vitae semper quis lectus nulla.
                                        Id ornare arcu odio ut sem nulla. In fermentum posuere urna nec tincidunt
                                        praesent semper feugiat nibh. Nulla facilisi cras fermentum odio eu.
                                        Suspendisse faucibus interdum posuere lorem ipsum dolor sit amet. Eget
                                        nullam non nisi est sit amet facilisis.

                                        Habitant morbi tristique senectus et. Lobortis mattis aliquam faucibus
                                        purus. Aliquam sem et tortor consequat id porta. At ultrices mi tempus
                                        imperdiet nulla malesuada pellentesque elit. Quisque non tellus orci ac
                                        auctor augue mauris augue neque. Duis ultricies lacus sed turpis tincidunt
                                        id. Nec feugiat in fermentum posuere urna nec tincidunt praesent. Fermentum
                                        leo vel orci porta. Cras adipiscing enim eu turpis egestas. Donec pretium
                                        vulputate sapien nec. Vitae tempus quam pellentesque nec nam. Lobortis
                                        mattis aliquam faucibus purus in massa tempor. Nulla posuere sollicitudin
                                        aliquam ultrices sagittis. Tellus mauris a diam maecenas sed enim ut.
                                        Rhoncus est pellentesque elit ullamcorper dignissim cras tincidunt lobortis.
                                        Nec sagittis aliquam malesuada bibendum arcu vitae elementum curabitur
                                        vitae. Id aliquet risus feugiat in ante. Habitasse platea dictumst quisque
                                        sagittis purus sit amet volutpat consequat.

                                        Enim blandit volutpat maecenas volutpat blandit aliquam etiam. Odio morbi
                                        quis commodo odio aenean sed. Cursus turpis massa tincidunt dui ut ornare.
                                        Dictum non consectetur a erat nam at lectus. Id volutpat lacus laoreet non
                                        curabitur gravida. Enim blandit volutpat maecenas volutpat blandit aliquam
                                        etiam. Sed lectus vestibulum mattis ullamcorper. Sit amet volutpat consequat
                                        mauris. At tempor commodo ullamcorper a lacus. Commodo quis imperdiet massa
                                        tincidunt nunc pulvinar sapien et ligula. Donec enim diam vulputate ut.
                                        Purus semper eget duis at tellus. Eget est lorem ipsum dolor sit amet. Non
                                        nisi est sit amet. Vitae turpis massa sed elementum tempus egestas sed sed.
                                        Id diam vel quam elementum. Nunc pulvinar sapien et ligula ullamcorper
                                        malesuada proin. Lorem dolor sed viverra ipsum nunc aliquet bibendum enim.
                                        Tempor id eu nisl nunc. Sit amet purus gravida quis.

                                        Turpis egestas maecenas pharetra convallis posuere morbi leo urna molestie.
                                        Quam nulla porttitor massa id. Tincidunt augue interdum velit euismod. Diam
                                        maecenas sed enim ut sem viverra aliquet eget. Laoreet id donec ultrices
                                        tincidunt arcu. Feugiat pretium nibh ipsum consequat nisl. Volutpat maecenas
                                        volutpat blandit aliquam etiam. Quis vel eros donec ac odio. Pharetra et
                                        ultrices neque ornare aenean euismod elementum. Habitasse platea dictumst
                                        vestibulum rhoncus est pellentesque elit ullamcorper dignissim. Sodales ut
                                        etiam sit amet nisl.
                                    </div>
                                    <div class="tab-pane fade" id="report-monitor" role="tabpanel"
                                        aria-labelledby="list-profile-list">
                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
                                        tempor incididunt ut labore et dolore magna aliqua. In mollis nunc sed id
                                        semper risus in hendrerit. Imperdiet dui accumsan sit amet nulla facilisi
                                        morbi tempus. Volutpat blandit aliquam etiam erat velit scelerisque. Mi sit
                                        amet mauris commodo quis imperdiet massa. At consectetur lorem donec massa.
                                        Augue ut lectus arcu bibendum at varius vel pharetra vel. Leo urna molestie
                                        at elementum eu. Sed arcu non odio euismod lacinia at quis risus sed.
                                        Suspendisse potenti nullam ac tortor vitae purus faucibus ornare. Blandit
                                        massa enim nec dui nunc mattis enim ut tellus. Facilisi cras fermentum odio
                                        eu feugiat. Id neque aliquam vestibulum morbi blandit cursus risus at.
                                        Luctus accumsan tortor posuere ac ut consequat semper viverra. Commodo elit
                                        at imperdiet dui accumsan sit amet nulla facilisi.

                                        Id porta nibh venenatis cras sed felis. Quis viverra nibh cras pulvinar
                                        mattis. Felis eget nunc lobortis mattis aliquam. Commodo viverra maecenas
                                        accumsan lacus vel facilisis. Ac tincidunt vitae semper quis lectus nulla.
                                        Id ornare arcu odio ut sem nulla. In fermentum posuere urna nec tincidunt
                                        praesent semper feugiat nibh. Nulla facilisi cras fermentum odio eu.
                                        Suspendisse faucibus interdum posuere lorem ipsum dolor sit amet. Eget
                                        nullam non nisi est sit amet facilisis.

                                        Habitant morbi tristique senectus et. Lobortis mattis aliquam faucibus
                                        purus. Aliquam sem et tortor consequat id porta. At ultrices mi tempus
                                        imperdiet nulla malesuada pellentesque elit. Quisque non tellus orci ac
                                        auctor augue mauris augue neque. Duis ultricies lacus sed turpis tincidunt
                                        id. Nec feugiat in fermentum posuere urna nec tincidunt praesent. Fermentum
                                        leo vel orci porta. Cras adipiscing enim eu turpis egestas. Donec pretium
                                        vulputate sapien nec. Vitae tempus quam pellentesque nec nam. Lobortis
                                        mattis aliquam faucibus purus in massa tempor. Nulla posuere sollicitudin
                                        aliquam ultrices sagittis. Tellus mauris a diam maecenas sed enim ut.
                                        Rhoncus est pellentesque elit ullamcorper dignissim cras tincidunt lobortis.
                                        Nec sagittis aliquam malesuada bibendum arcu vitae elementum curabitur
                                        vitae. Id aliquet risus feugiat in ante. Habitasse platea dictumst quisque
                                        sagittis purus sit amet volutpat consequat.

                                        Enim blandit volutpat maecenas volutpat blandit aliquam etiam. Odio morbi
                                        quis commodo odio aenean sed. Cursus turpis massa tincidunt dui ut ornare.
                                        Dictum non consectetur a erat nam at lectus. Id volutpat lacus laoreet non
                                        curabitur gravida. Enim blandit volutpat maecenas volutpat blandit aliquam
                                        etiam. Sed lectus vestibulum mattis ullamcorper. Sit amet volutpat consequat
                                        mauris. At tempor commodo ullamcorper a lacus. Commodo quis imperdiet massa
                                        tincidunt nunc pulvinar sapien et ligula. Donec enim diam vulputate ut.
                                        Purus semper eget duis at tellus. Eget est lorem ipsum dolor sit amet. Non
                                        nisi est sit amet. Vitae turpis massa sed elementum tempus egestas sed sed.
                                        Id diam vel quam elementum. Nunc pulvinar sapien et ligula ullamcorper
                                        malesuada proin. Lorem dolor sed viverra ipsum nunc aliquet bibendum enim.
                                        Tempor id eu nisl nunc. Sit amet purus gravida quis.

                                        Turpis egestas maecenas pharetra convallis posuere morbi leo urna molestie.
                                        Quam nulla porttitor massa id. Tincidunt augue interdum velit euismod. Diam
                                        maecenas sed enim ut sem viverra aliquet eget. Laoreet id donec ultrices
                                        tincidunt arcu. Feugiat pretium nibh ipsum consequat nisl. Volutpat maecenas
                                        volutpat blandit aliquam etiam. Quis vel eros donec ac odio. Pharetra et
                                        ultrices neque ornare aenean euismod elementum. Habitasse platea dictumst
                                        vestibulum rhoncus est pellentesque elit ullamcorper dignissim. Sodales ut
                                        etiam sit amet nisl.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="list-settings" role="tabpanel" aria-labelledby="status-list">
                        <h1>Status</h1>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Optional JavaScript -->
    <script>

        // Get data from server
        var data = JSON.parse("{{data}}".replace(/&#34;/g, '"')).data
        console.log(data)
        var dt_l1 = [], dt_l2 = [], dt_l3 = [], dt_l4 = []
        for (var i = 0; i < data.length; i++) {
            switch (data[i].device_id) {
                case "Light": dt_l1.push(data[i].value); break;
                case 2: dt_l2.push(data[i].value); break;
                case 3: dt_l3.push(data[i].value); break;
                case 4: dt_l4.push(data[i].value); break;
            }
        }

        // Get data to display in overview chart
        var l1_chart = [], l2_chart = [], l3_chart = [], l4_chart = []
        for (var i = dt_l1.length - 7; i < dt_l1.length; i++) {
            l1_chart.push(dt_l1[i])
        }

        document.getElementById('report-date').valueAsDate = new Date();
        $(document).ready(function () {
            var val = document.getElementById('adjust-in').value
            var switch_btn = document.getElementById('switch-btn')
            adjust(val)
            check()
        })

        document.getElementById('adjust-in').value = l1_chart[l1_chart.length - 1]
        function adjust(val) {
            let bulb = document.getElementById('adjust-out')
            let bulb_img = document.getElementById('bulb_img')
            if (0 <= val && val < 80) {
                bulb.value = "Low"
                bulb.style.color = "lightseagreen"
                bulb.style.textAlign = "left"
                bulb_img.src = "{{ url_for('static', filename='./img/bulb_low.png') }}"
            }
            else if (80 <= val && val < 170) {
                bulb.value = "Normal"
                bulb.style.color = "lightgreen"
                bulb.style.textAlign = "center"
                bulb_img.src = "{{ url_for('static', filename='./img/bulb_normal.png') }}"
            }
            else {
                bulb.value = "High"
                bulb.style.color = "lightcoral"
                bulb.style.textAlign = "right"
                bulb_img.src = "{{ url_for('static', filename='./img/bulb_high.png') }}"
            }
        }

        function check() {
            let checked = document.getElementById('switch-btn').checked
            let ctrl_adjust = document.getElementById('ctrl-adjust').style
            let ctrl_2 = document.getElementById('ctrl-2').style
            if (!checked) {
                ctrl_2.display = "none"
                ctrl_adjust.display = "none"
            }
            else {
                ctrl_2.display = "block"
                ctrl_adjust.display = "block"
            }
        }

        // Create chart label
        var chart_timer = setInterval(changeLabel, parseInt("{{(loop_time + 1)*5000}}"))
        var chart_label = []
        for (var i = 6; i >= 0; i--) {
            var t = new Date(new Date().getTime() - (6 - i) * parseInt("{{(loop_time + 1)*5000}}"))
            var hour = t.getHours()
            var min = t.getMinutes() - t.getMinutes() % 5
            chart_label[i] = hour + ':' + min
        }

        update_chart()

        // Update chart label
        function changeLabel() {
            var t = new Date()
            var hour = t.getHours()
            var min = t.getMinutes() - t.getMinutes() % 5
            chart_label.shift()
            chart_label.push(hour + ':' + min)
            update_chart_data()
            update_chart()
        }

        // Function to update overview chart
        function update_chart() {
            // Redraw the overview chart
            var ctx = document.getElementById('myChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chart_label,
                    datasets: [{
                        label: 'Light intensity',
                        data: l1_chart,
                        backgroundColor: [
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 3
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        }

        // Function to update chart data
        function update_chart_data() {
            $.ajax({
                url: "{{url_for('get_data', username = username)}}",
                success: function (updated_data) {
                    data = JSON.parse(updated_data.replace(/&#34;/g, '"')).data
                    console.log(data)
                }
            })
        }

        // Function send light adjustment
        function send_adjust() {
            var val = document.getElementById('adjust-in').value
            var switch_btn = document.getElementById('switch-btn')
            if (!switch_btn.checked || val == 0) {
                var data = {
                    device_id: "LightD",
                    values: ["0", "0"]
                }
            }
            else {
                // var val = document.getElementById('adjust-in').value
                data = {
                    device_id: "LightD",
                    values: ["1", String(val)]
                }
            }
            console.log(data)
            $.ajax({
                method: 'POST',
                url: "{{url_for('set_data', username = username)}}",
                data: JSON.stringify(data),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json'
            })
        }
    </script>
</body>

</html>